<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>upload podcast</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
<div class="container text-center">
    <div class="mb-3">
        <label for="tenTruyen" class="form-label">Tên truyện</label>
        <input class="form-control" id="tenTruyen"/>
    </div>
    <div class="mb-3">
        <label for="tacGia" class="form-label">Tác giả</label>
        <input class="form-control" id="tacGia"/>
    </div>
    <div class="mb-3">
        <label for="loai" class="form-label">Loại</label>
        <input class="form-control" id="loai"/>
    </div>
    <div class="mb-3">
        <label for="thongTin" class="form-label">Thông tin</label>
        <input class="form-control" id="thongTin"/>
    </div>
    <div class="mb-3">
        <label for="anhbia" class="form-label">Chọn ảnh</label>
        <input class="form-control" type="file" id="anhbia" onchange="getImageData(event)"/>
    </div>
    <div class="progressBarImage">
        <div class="progressImage"></div>
    </div>
    <div class="mb-3">
        <label for="formFile" class="form-label">Chọn tệp</label>
        <input class="form-control" type="file" id="formFile" onchange="getFileData(event)">
    </div>
    <div class="progressBar">
        <div class="progress"></div>
    </div>
    <button class="btn btn-primary upload" onclick="uploadAll()">Tải lên</button>
</div>
</body>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.8/firebase-app.js" integrity="sha512-k93GGJOBhI/dCX2l1TT4SSpRQKGOXSY/84uhJD9XIcH4UAHbXwD7lMiA+LrvgcXSTJioLAysS1C4ytN6vOWyQw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.8/firebase-firestore.min.js" integrity="sha512-JKzxb1G8pPyxwor3TWrSEqriDnt3rLFk8OpFaYW5fAB63AYfN5IqK81b6NJpg30/nKGt+OEnx5wU3M/pdNKCkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.8/firebase-storage.min.js" integrity="sha512-XUKQJZooy9v/gobhAXXy5JsCdpZycaYKJzFBpHnn+jycSSNYBm59mA/XFZ37t9rj89iH+I+1RaG8FqE2Rs2tpw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script
  src="https://code.jquery.com/jquery-3.7.1.js"
  integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
<script>
    // Import the functions you need from the SDKs you need
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    // const firebaseConfig = {
    //     apiKey: "AIzaSyDDSE5F0jhmpvtX-z7o-1L9RpUc5u1bodM",
    //     authDomain: "mlis-18b55.firebaseapp.com",
    //     projectId: "mlis-18b55",
    //     storageBucket: "mlis-18b55.appspot.com",
    //     messagingSenderId: "1072635823588",
    //     appId: "1:1072635823588:web:02120dbc2809327ac0f3f1",
    //     measurementId: "G-ZMWW7ZNJCG"
    // };

    // const app = firebase.initializeApp(firebaseConfig);
    // console.log(app)
    // const storage = firebase.storage();
    // const firestoredb = firebase.firestore();
    const inp = document.querySelector(".inp");
    const progressbar = document.querySelector(".progress");
    const progressbarImage = document.querySelector(".progressImage");
    const img = document.querySelector(".img");
    const fileData = document.querySelector(".filedata");
    const loading = document.querySelector(".loading");
    let file;
    let fileName;
    let fileImage;
    let fileImageName;
    let progress;
    let progressImage;
    let isLoading = false;
    let uploadedImageFileName;
    let imageUrl;
    let fileUrl;

    let imgOk = false;
    let fileOk = false;
    function getImageData(e) {
        fileImage = e.target.files[0];
        fileImageName = Math.round(Math.random() * 9999) + fileImage.name;
        console.log(fileImage, fileImageName);
    }
    function getFileData(e) {
        file = e.target.files[0];
        fileName = Math.round(Math.random() * 9999) + file.name;
        console.log(file, fileName);
    }

    // function uploadImage () {
    //     const storageRef = storage.ref().child("myimages");
    //     const folderRef = storageRef.child(fileImageName);
    //     const uploadtask = folderRef.put(fileImage);
    //     uploadtask.on(
    //         "state_changed",
    //         (snapshot) => {
    //             console.log("Snapshot", snapshot.ref.name);
    //             progressImage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    //             progressImage = Math.round(progressImage);
    //             progressbarImage.style.width = progressImage + "%";
    //             progressbarImage.innerHTML = progressImage + "%";
    //             uploadedImageFileName = snapshot.ref.name;
    //         },
    //         (error) => {
    //             console.log(error);
    //         },
    //         () => {
    //             storage
    //                 .ref("myimages")
    //                 .child(uploadedImageFileName)
    //                 .getDownloadURL()
    //                 .then((url) => {
    //                     console.log("URL", url);
    //                     imageUrl = url;
    //                     imgOk = true;
    //                 });
    //             console.log("File Uploaded Successfully");
    //         }
    //     );
    // }
    // function uploadFile () {
    //     let uploadedFileName;
    //     const storagefRef = storage.ref().child("myfiles");
    //     const folderRef = storagefRef.child(fileName);
    //     const uploadtask = folderRef.put(file);
    //     uploadtask.on(
    //         "state_changed",
    //         (snapshot) => {
    //             console.log("Snapshot", snapshot.ref.name);
    //             progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    //             progress = Math.round(progress);
    //             progressbar.style.width = progress + "%";
    //             progressbar.innerHTML = progress + "%";
    //             uploadedFileName = snapshot.ref.name;
    //         },
    //         (error) => {
    //             console.log(error);
    //         },
    //         () => {
    //             storage
    //                 .ref("myfiles")
    //                 .child(uploadedFileName)
    //                 .getDownloadURL()
    //                 .then((url) => {
    //                     console.log("URL", url);
    //                     fileUrl = url;
    //                     fileOk = true;
    //                 });
    //             console.log("File Uploaded Successfully");
    //         }
    //     );
    // }
    function sendUploadPodcastRequest(name, category, author, inf){
        const request = new XMLHttpRequest();
        const formData = new FormData;
        const urlendpoint = "http://localhost:8080/api/podcast/uploadpodcast";
        request.open("POST", urlendpoint, true);
        request.onreadystatechange = () => {
            if (request.readyState === 4 && request.status === 200) {
                console.log(request.responseText);
            }
        };
        formData.append("file", file);
        formData.append("image", fileImage);
        let podcast = {
            name: name? name : "Không tên",
            inf: inf? inf:"Không có thông tin",
            createOn: "no set",
            createBy: "localhost",
            author: author? author:"Không biết tác giả",
            category: category? category: "trống",
            url: fileName,
            urlImg: fileImageName,
            status: "1"
        }
        podcast = JSON.stringify(podcast);
        console.log(podcast);
        formData.append("podcast", podcast);
        request.send(formData);
    }
    async function uploadAll (){
        const name = document.getElementById("tenTruyen").value;
        const category = document.getElementById("loai").value;
        const author = document.getElementById("tacGia").value;
        const inf = document.getElementById("thongTin").value;
        sendUploadPodcastRequest(name, category, author, inf);
        // imgOk = false;
        // fileOk = false;
        // uploadImage()
        // uploadFile()
        // while(!imgOk){
        //     console.log("waiting img");
        //     await new Promise(r => setTimeout(r, 1000));
        // }
        // while(!fileOk){
        //     console.log("waiting file");
        //     await new Promise(r => setTimeout(r, 1000));
        // }
        // console.log("upload ok")
        // try{
        //     const addRef = addDoc(doc(firestoredb, "podcast"),{
        //     name: name? name:"Không có tên",
        //     category: category? category:"Trống",
        //     inf: inf? inf:"Không có mô tả",
        //     createBy: "localhost",
        //     createOn: new Date().toDateString(),
        //     author: author? author : "Không có thông tin tác giả",
        //     status: "1",
        //     url: fileUrl,
        //     urlImg: imageUrl
        // });
        // console.log("Added with id: ", addRef.id);
    // }
    // catch(e){
    //     console.log("adding error", e);
    // }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</html>